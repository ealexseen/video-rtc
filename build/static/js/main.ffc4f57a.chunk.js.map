{"version":3,"sources":["hooks/useStateWithCallback.js","socket/index.js","hooks/useWebRTC.js","pages/Room/index.js","pages/Main/index.js","pages/NotFound404/index.js","App.js","index.js","socket/actions.js"],"names":["useStateWithCallback","initialState","useState","state","setState","cbRef","useRef","updateState","useCallback","newState","cb","current","prev","useEffect","socket","io","reconnectionAttempts","timeout","transports","LOCAL_VIDEO","Room","roomID","clients","updateClients","addNewClient","newClient","list","includes","peerConnections","localMediaStream","peerMediaElements","a","peerID","createOffer","console","warn","RTCPeerConnection","iceServers","freeice","onicecandidate","event","candidate","emit","ACTIONS","RELAY_ICE","iceCandidate","tracksNumber","ontrack","remoteStream","streams","srcObject","settled","interval","setInterval","clearInterval","getTracks","forEach","track","addTrack","offer","setLocalDescription","RELAY_SDP","sessionDescription","on","ADD_PEER","off","remoteDescription","setRemoteDescription","RTCSessionDescription","type","createAnswer","answer","SESSION_DESCRIPTION","ICE_CANDIDATE","addIceCandidate","RTCIceCandidate","REMOVE_PEER","close","filter","c","navigator","mediaDevices","getUserMedia","audio","video","width","height","localVideoElement","volume","startCapture","then","JOIN","room","catch","e","error","stop","LEAVE","provideMediaRef","id","node","useWebRTC","useParams","videoLayout","clientsNumber","pairs","Array","from","length","reduce","acc","next","index","arr","push","slice","rowsNumber","map","row","flat","layout","style","display","alignItems","justifyContent","flexWrap","clientID","ref","instance","autoPlay","playsInline","muted","Main","history","useHistory","rooms","updateRooms","rootNode","SHARE_ROOMS","onClick","v4","NotFound404","App","exact","path","component","ReactDOM","render","StrictMode","document","getElementById","module","exports"],"mappings":"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","file":"static/js/main.ffc4f57a.chunk.js","sourcesContent":["import {useState, useCallback, useRef, useEffect} from 'react';\n\nconst useStateWithCallback = initialState => {\n  const [state, setState] = useState(initialState);\n  const cbRef = useRef(null);\n\n  const updateState = useCallback((newState, cb) => {\n    cbRef.current = cb;\n\n    setState(prev => typeof newState === 'function' ? newState(prev) : newState);\n  }, []);\n\n  useEffect(() => {\n    if (cbRef.current) {\n      cbRef.current(state);\n      cbRef.current = null;\n    }\n  }, [state]);\n\n  return [state, updateState];\n}\n\nexport default useStateWithCallback;","import {io} from 'socket.io-client';\n\nconst options = {\n  \"force new connection\": true,\n  reconnectionAttempts: \"Infinity\", // avoid having user reconnect manually in order to prevent dead clients after a server restart\n  timeout : 10000, // before connect_error and connect_timeout are emitted.\n  transports : [\"websocket\"]\n}\n\nconst socket = io('/', options);\n\nexport default socket;\n","import {useEffect, useRef, useCallback} from 'react';\nimport freeice from 'freeice';\nimport useStateWithCallback from './useStateWithCallback';\nimport socket from '../socket';\nimport ACTIONS from '../socket/actions';\n\nexport const LOCAL_VIDEO = 'LOCAL_VIDEO';\n\n\nexport default function useWebRTC(roomID) {\n  const [clients, updateClients] = useStateWithCallback([]);\n\n  const addNewClient = useCallback((newClient, cb) => {\n    updateClients(list => {\n      if (!list.includes(newClient)) {\n        return [...list, newClient]\n      }\n\n      return list;\n    }, cb);\n  }, [clients, updateClients]);\n\n  const peerConnections = useRef({});\n  const localMediaStream = useRef(null);\n  const peerMediaElements = useRef({\n    [LOCAL_VIDEO]: null,\n  });\n\n  useEffect(() => {\n    async function handleNewPeer({peerID, createOffer}) {\n      if (peerID in peerConnections.current) {\n        return console.warn(`Already connected to peer ${peerID}`);\n      }\n\n      peerConnections.current[peerID] = new RTCPeerConnection({\n        iceServers: freeice(),\n      });\n\n      peerConnections.current[peerID].onicecandidate = event => {\n        if (event.candidate) {\n          socket.emit(ACTIONS.RELAY_ICE, {\n            peerID,\n            iceCandidate: event.candidate,\n          });\n        }\n      }\n\n      let tracksNumber = 0;\n      peerConnections.current[peerID].ontrack = ({streams: [remoteStream]}) => {\n        tracksNumber++\n\n        if (tracksNumber === 2) { // video & audio tracks received\n          tracksNumber = 0;\n          addNewClient(peerID, () => {\n            if (peerMediaElements.current[peerID]) {\n              peerMediaElements.current[peerID].srcObject = remoteStream;\n            } else {\n              // FIX LONG RENDER IN CASE OF MANY CLIENTS\n              let settled = false;\n              const interval = setInterval(() => {\n                if (peerMediaElements.current[peerID]) {\n                  peerMediaElements.current[peerID].srcObject = remoteStream;\n                  settled = true;\n                }\n\n                if (settled) {\n                  clearInterval(interval);\n                }\n              }, 1000);\n            }\n          });\n        }\n      }\n\n      localMediaStream.current.getTracks().forEach(track => {\n        peerConnections.current[peerID].addTrack(track, localMediaStream.current);\n      });\n\n      if (createOffer) {\n        const offer = await peerConnections.current[peerID].createOffer();\n\n        await peerConnections.current[peerID].setLocalDescription(offer);\n\n        socket.emit(ACTIONS.RELAY_SDP, {\n          peerID,\n          sessionDescription: offer,\n        });\n      }\n    }\n\n    socket.on(ACTIONS.ADD_PEER, handleNewPeer);\n\n    return () => {\n      socket.off(ACTIONS.ADD_PEER);\n    }\n  }, []);\n\n  useEffect(() => {\n    async function setRemoteMedia({peerID, sessionDescription: remoteDescription}) {\n      await peerConnections.current[peerID]?.setRemoteDescription(\n        new RTCSessionDescription(remoteDescription)\n      );\n\n      if (remoteDescription.type === 'offer') {\n        const answer = await peerConnections.current[peerID].createAnswer();\n\n        await peerConnections.current[peerID].setLocalDescription(answer);\n\n        socket.emit(ACTIONS.RELAY_SDP, {\n          peerID,\n          sessionDescription: answer,\n        });\n      }\n    }\n\n    socket.on(ACTIONS.SESSION_DESCRIPTION, setRemoteMedia)\n\n    return () => {\n      socket.off(ACTIONS.SESSION_DESCRIPTION);\n    }\n  }, []);\n\n  useEffect(() => {\n    socket.on(ACTIONS.ICE_CANDIDATE, ({peerID, iceCandidate}) => {\n      peerConnections.current[peerID]?.addIceCandidate(\n        new RTCIceCandidate(iceCandidate)\n      );\n    });\n\n    return () => {\n      socket.off(ACTIONS.ICE_CANDIDATE);\n    }\n  }, []);\n\n  useEffect(() => {\n    const handleRemovePeer = ({peerID}) => {\n      if (peerConnections.current[peerID]) {\n        peerConnections.current[peerID].close();\n      }\n\n      delete peerConnections.current[peerID];\n      delete peerMediaElements.current[peerID];\n\n      updateClients(list => list.filter(c => c !== peerID));\n    };\n\n    socket.on(ACTIONS.REMOVE_PEER, handleRemovePeer);\n\n    return () => {\n      socket.off(ACTIONS.REMOVE_PEER);\n    }\n  }, []);\n\n  useEffect(() => {\n    async function startCapture() {\n      localMediaStream.current = await navigator.mediaDevices.getUserMedia({\n        audio: true,\n        video: {\n          width: 1280,\n          height: 720,\n        }\n      });\n\n      addNewClient(LOCAL_VIDEO, () => {\n        const localVideoElement = peerMediaElements.current[LOCAL_VIDEO];\n\n        if (localVideoElement) {\n          localVideoElement.volume = 0;\n          localVideoElement.srcObject = localMediaStream.current;\n        }\n      });\n    }\n\n    startCapture()\n      .then(() => socket.emit(ACTIONS.JOIN, {room: roomID}))\n      .catch(e => console.error('Error getting userMedia:', e));\n\n    return () => {\n      localMediaStream.current.getTracks().forEach(track => track.stop());\n\n      socket.emit(ACTIONS.LEAVE);\n    };\n  }, [roomID]);\n\n  const provideMediaRef = useCallback((id, node) => {\n    peerMediaElements.current[id] = node;\n  }, []);\n\n  return {\n    clients,\n    provideMediaRef\n  };\n}","import {useParams} from 'react-router';\nimport useWebRTC, {LOCAL_VIDEO} from '../../hooks/useWebRTC';\n\nfunction layout(clientsNumber = 1) {\n  const pairs = Array.from({length: clientsNumber})\n    .reduce((acc, next, index, arr) => {\n      if (index % 2 === 0) {\n        acc.push(arr.slice(index, index + 2));\n      }\n\n      return acc;\n    }, []);\n\n  const rowsNumber = pairs.length;\n  const height = `${100 / rowsNumber}%`;\n\n  return pairs.map((row, index, arr) => {\n\n    if (index === arr.length - 1 && row.length === 1) {\n      return [{\n        width: '100%',\n        height,\n      }];\n    }\n\n    return row.map(() => ({\n      width: '50%',\n      height,\n    }));\n  }).flat();\n}\n\nexport default function Room() {\n  const {id: roomID} = useParams();\n  const {clients, provideMediaRef} = useWebRTC(roomID);\n  const videoLayout = layout(clients.length);\n\n  return (\n    <div style={{\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center',\n      flexWrap: 'wrap',\n      height: '100vh',\n    }}>\n      {clients.map((clientID, index) => {\n        return (\n          <div key={clientID} style={videoLayout[index]} id={clientID}>\n            <video\n              width='100%'\n              height='100%'\n              ref={instance => {\n                provideMediaRef(clientID, instance);\n              }}\n              autoPlay\n              playsInline\n              muted={clientID === LOCAL_VIDEO}\n            />\n          </div>\n        );\n      })}\n    </div>\n  );\n}","import {useState, useEffect, useRef} from 'react';\nimport socket from '../../socket';\nimport ACTIONS from '../../socket/actions';\nimport {useHistory} from 'react-router';\nimport {v4} from 'uuid';\n\nexport default function Main() {\n  const history = useHistory();\n  const [rooms, updateRooms] = useState([]);\n  const rootNode = useRef();\n\n  useEffect(() => {\n    socket.on(ACTIONS.SHARE_ROOMS, ({rooms = []} = {}) => {\n      if (rootNode.current) {\n        updateRooms(rooms);\n      }\n    });\n  }, []);\n\n  return (\n    <div ref={rootNode}>\n      <h1>Available Rooms</h1>\n\n      <ul>\n        {rooms.map(roomID => (\n          <li key={roomID}>\n            {roomID}\n            <button onClick={() => {\n              history.push(`/room/${roomID}`);\n            }}>JOIN ROOM</button>\n          </li>\n        ))}\n      </ul>\n\n      <button onClick={() => {\n        history.push(`/room/${v4()}`);\n      }}>Create New Room</button>\n    </div>\n  );\n}","export default function NotFound404() {\n  return (\n    <div>\n      NOT FOUND.\n    </div>\n  );\n}","import {BrowserRouter, Switch, Route} from 'react-router-dom';\nimport Room from './pages/Room';\nimport Main from './pages/Main';\nimport NotFound404 from './pages/NotFound404';\n\nfunction App() {\n  return (\n    <BrowserRouter>\n      <Switch>\n        <Route exact path='/room/:id' component={Room}/>\n        <Route exact path='/' component={Main}/>\n        <Route component={NotFound404}/>\n      </Switch>\n    </BrowserRouter>\n  );\n}\n\nexport default App;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n","const ACTIONS = {\n  JOIN: 'join',\n  LEAVE: 'leave',\n  SHARE_ROOMS: 'share-rooms',\n  ADD_PEER: 'add-peer',\n  REMOVE_PEER: 'remove-peer',\n  RELAY_SDP: 'relay-sdp',\n  RELAY_ICE: 'relay-ice',\n  ICE_CANDIDATE: 'ice-candidate',\n  SESSION_DESCRIPTION: 'session-description'\n};\n\nmodule.exports = ACTIONS;"],"sourceRoot":""}